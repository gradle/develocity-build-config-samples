name: Maven smoke test

on: [push]

jobs:
    verify-maven-samples:
        runs-on: ubuntu-latest
        env:
            LOG_CCUD_EXTENSION_LOADED: "Build operation 'Gradle Enterprise mojo execution' completed"
            LOG_CCUD_EXECUTION_FAILURE: "Error executing a GradleEnterpriseListener callback"

        strategy:
            matrix:
                include:
                    - relative-path-to-sample-build-file: "default"
                    - relative-path-to-sample-build-file: "capture-os-processes/maven-os-processes.groovy"
                    - relative-path-to-sample-build-file: "capture-quality-check-issues/maven-quality-check-issues.groovy"
                    - relative-path-to-sample-build-file: "capture-top-level-project/maven-top-level-project.groovy"

        steps:
            - uses: actions/checkout@v2
            - name: Set up JDK 11
              uses: actions/setup-java@v2
              with:
                  java-version: '11'
                  distribution: 'adopt'
            - name: Copy current sample
              run: |
                  # default uses the original gradle-enterprise-custom-user-data.groovy
                  if [[ ${{ matrix.relative-path-to-sample-build-file }} != "default" ]]; then
                      cp ${{ matrix.relative-path-to-sample-build-file }} common-custom-user-data-maven-extension/.mvn/gradle-enterprise-custom-user-data.groovy
                  fi
            - name: Run Maven build using CCUD extension
              run: |
                  echo 'MAVEN_OUTPUT<<EOF' >> $GITHUB_ENV
                  mvn -f common-custom-user-data-maven-extension/pom.xml -X --batch-mode clean validate >> $GITHUB_ENV
                  echo 'EOF' >> $GITHUB_ENV
            - name: Validate extension load
              run: |
                  echo $MAVEN_OUTPUT | grep "$LOG_CCUD_EXTENSION_LOADED"
            - name: Validate extension execution
              run: |
                  echo $MAVEN_OUTPUT | grep -L "$LOG_CCUD_EXECUTION_FAILURE"
