import groovy.json.JsonBuilder
import groovy.json.JsonSlurper

import java.nio.charset.Charset
import java.util.concurrent.TimeUnit

/**
 * This Gradle script captures the <i>Git diff</i> in a GitHub gist,
 * and references the gist via a custom link.
 * This should be applied to the root project:
 * <code> apply from: file('gradle-git-diffs.gradle') </code>
 *
 * In order for the gist to be created successfully, you must specify the Gradle property `gistToken` where
 * the value is a Github access token that has gist permission on the given Github repo.
 *
 * See https://docs.github.com/en/rest/gists/gists#create-a-gist for reference.
 */

def buildScanApi = project.extensions.findByName('buildScan')
if (!buildScanApi) {
    return
}

buildScan.background {
    captureGitDiffInGist()
}

void captureGitDiffInGist() {
    def isCapturingScan = !gradle.startParameter.offline && !gradle.startParameter.continuous
    if (!isCapturingScan) {
        gradle.rootProject.logger.warn("Build is offline or continuous. Will not publish gist.")
        return
    }

    def hasGistCredentials = gradle.rootProject.hasProperty('gistToken')
    if (!hasGistCredentials) {
        gradle.rootProject.logger.warn("User has not set 'gistToken'. Cannot publish gist.")
        return
    }

    def diff = execAndGetStdout('git', 'diff')
    if (diff) {
        try {
            def baseUrl = new URL('https://api.github.com/gists')
            def credentials = gradle.rootProject.findProperty('gistToken')
            def basicAuth = "Basic ${credentials.bytes.encodeBase64()}"

            HttpURLConnection connection = (HttpURLConnection) baseUrl.openConnection()
            connection.with {
                // request
                setRequestProperty('Authorization', basicAuth)
                setRequestProperty('Accept', 'application/vnd.github.v3+json')
                requestMethod = 'POST'
                doOutput = true
                outputStream.withWriter { writer ->
                    jsonRequest(writer, diff, gradle.rootProject)
                }

                // response
                def url = new JsonSlurper().parse(content.text.bytes).html_url
                buildScan.link('Git diff', url)
            }
            gradle.rootProject.logger.info('Successfully published gist.')
        } catch (ex) {
            gradle.rootProject.logger.warn('Unable to publish gist', ex)
        }
    }
}

// this method must be static, otherwise Gradle will interpret `files` as Project.files() and this won't work
static void jsonRequest(Writer writer, String diff, Project project) {
    def builder = new JsonBuilder()
    builder {
        description "Git diff for $project.name"
        'public' false
        files {
            "${project.name}.diff" {
                content diff
            }
        }
    }
    builder.writeTo(writer)
}

static String execAndGetStdout(String... args) {
    Process process = args.toList().execute()
    try {
        def standardText = process.inputStream.withStream { s -> s.getText(Charset.defaultCharset().name()) }
        def ignore = process.errorStream.withStream { s -> s.getText(Charset.defaultCharset().name()) }

        def finished = process.waitFor(10, TimeUnit.SECONDS);
        finished && process.exitValue() == 0 ? trimAtEnd(standardText) : null;
    } finally {
        process.destroyForcibly()
    }
}

static String trimAtEnd(String str) {
    ('x' + str).trim().substring(1)
}
